<!--
Nathan Ehnes
2024-25 Sem 2 Creative Eng Project
-->
<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Motor Control</title>
    <!-- pre-existing joystick library pulled from web by client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/nipplejs/0.10.0/nipplejs.min.js"></script>
    <style>

        /* add text div later on */

        /* joystick div */
        #joystick {
            width: 200px;
            height: 200px;
            position: fixed;
            left: 150px;
            top: 50%;
            transform: translateY(-50%);
            /* border: 3px solid slateblue; */
            /* background-color: rgba(100, 100, 100, 0.1); /* So you can see the container */
        }
        /* camera stream div */
        #stream {
            width: 640px;
            height: 480px;
            position: fixed;
            left: 70%;
            top: 50%;
            transform: translate(-50%, -50%); /* Centers it at that position */
            border-radius: 25px;
        }
    </style>
</head>
<body style="text-align:center; font-family:Arial, sans-serif; background-color: darkslategrey;">
    <h1 style="text-align: left; color: fuchsia;">ESP32 Motor Control</h1>
    <p style="text-align: left; font-style: italic; color: fuschia;">Welcome to the ESP32 motor control interface!</p>

    <!-- img element for camera feed -->
    <img id="stream" src="">
    
    <div id="joystick"></div>
    
    <script>
        // connect to WebSocket
        const socket = new WebSocket('ws://' + window.location.hostname + '/ws');
        socket.binaryType = 'arraybuffer';

        // when connected
        socket.onopen = () => {
            console.log('WebSocket connected!');
        };

        // accept data from esp
        socket.onmessage = (event) => {
            if (typeof event.data === 'string') {
                // TEXT messages - not used
                console.log('ESP32 says:', event.data);
            } else {
                // IMAGES
                const img = document.getElementById('stream');
                const blob = new Blob([event.data], { type: 'image/jpeg' });
                img.src = URL.createObjectURL(blob);
            }
        };

        // create and configure the nipple.js joystick
        const joystick = nipplejs.create({
            zone: document.getElementById('joystick'), // attach joystick to the #joystick div
            mode: 'static', // 
            position: { left: '50%', top: '50%' }, // center joystick in div
            color: 'hotpink',
            size: 300 // diameter
        });

        // event listener for joystick movement
        joystick.on('move', function(evt, data) {
            // check if movement data includes direction and distance
            if (data.direction && data.distance) {
                const angle = data.angle.degree; // 0 is right, moving ccw
                const speed = Math.min(data.distance / 50, 1) * 100; // 0-100 strength range

                let angleRad = angle * Math.PI / 180.0; // to radians
                let xSpeed = speed * Math.cos(angleRad); // range: [-100, 100]
                let ySpeed = speed * Math.sin(angleRad); // range: [-100, 100]

                let vL = ySpeed + xSpeed; // left motor speed
                let vR = ySpeed - xSpeed; // right motor speed

                // normalize speeds to be within [-100, 100]
                const maxSpeed = Math.max(Math.abs(vL), Math.abs(vR));
                if (maxSpeed > 100) {
                    vL = (vL / maxSpeed) * 100;
                    vR = (vR / maxSpeed) * 100;
                } 

                // send data to ESP32
                const buffer = new ArrayBuffer(8);
                const view = new Float32Array(buffer);

                view[0] = vL;
                view[1] = vR;

                socket.send(buffer);
            }
        });

        // event listener for when the joystick is released
        joystick.on('end', function() {
            // socket.send("AT REST");

            // new, optimized version
            const buffer = new ArrayBuffer(8);
            const view = new Float32Array(buffer);

            view[0] = 0;
            view[1] = 0;

            socket.send(buffer);
        });
    </script>
</body>
</html>